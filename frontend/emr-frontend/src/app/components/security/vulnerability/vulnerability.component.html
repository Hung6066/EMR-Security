<div class="container">
  <h1>Vulnerability Management</h1>

  <div class="dashboard-grid">
    <mat-card class="chart-card">
      <mat-card-header><mat-card-title>Tổng quan lỗ hổng</mat-card-title></mat-card-header>
      <mat-card-content>
        <div style="display: block">
          <canvas baseChart 
                  [data]="chartData" 
                  [type]="'doughnut'" 
                  [options]="chartOptions">
          </canvas>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="import-card">
      <mat-card-header><mat-card-title>Import Scan Report</mat-card-title></mat-card-header>
      <mat-card-content>
        <p>Tải lên file kết quả từ các công cụ quét bảo mật.</p>
        <div class="import-actions">
          <button mat-stroked-button (click)="fileInputTrivy.click()">
            <mat-icon>upload_file</mat-icon> Import Trivy (JSON)
          </button>
          <input hidden (change)="onFileSelected($event, 'Trivy')" #fileInputTrivy type="file" accept=".json">

          <button mat-stroked-button (click)="fileInputZap.click()">
            <mat-icon>upload_file</mat-icon> Import ZAP (XML)
          </button>
          <input hidden (change)="onFileSelected($event, 'ZAP')" #fileInputZap type="file" accept=".xml">
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <mat-card class="table-card">
    <mat-card-header><mat-card-title>Danh sách lỗ hổng đang tồn tại</mat-card-title></mat-card-header>
    <mat-card-content>
      <div *ngIf="loading" class="loading-spinner"><mat-spinner></mat-spinner></div>
      <table *ngIf="!loading" mat-table [dataSource]="vulnerabilities" class="mat-elevation-z2">
        <!-- Columns -->
        <ng-container matColumnDef="severity"><th mat-header-cell *matHeaderCellDef>Mức độ</th><td mat-cell *matCellDef="let v"><mat-chip [color]="getSeverityColor(v.severity)" selected>{{ v.severity }}</mat-chip></td></ng-container>
        <ng-container matColumnDef="cveId"><th mat-header-cell *matHeaderCellDef>CVE ID</th><td mat-cell *matCellDef="let v"><a [href]="'https://nvd.nist.gov/vuln/detail/' + v.cveId" target="_blank">{{ v.cveId }}</a></td></ng-container>
        <ng-container matColumnDef="packageName"><th mat-header-cell *matHeaderCellDef>Package</th><td mat-cell *matCellDef="let v"><code>{{ v.packageName }}</code></td></ng-container>
        <ng-container matColumnDef="vulnerableVersion"><th mat-header-cell *matHeaderCellDef>Version</th><td mat-cell *matCellDef="let v">{{ v.vulnerableVersion }}</td></ng-container>
        <ng-container matColumnDef="status"><th mat-header-cell *matHeaderCellDef>Trạng thái</th><td mat-cell *matCellDef="let v">{{ v.status }}</td></ng-container>
        <ng-container matColumnDef="scanner"><th mat-header-cell *matHeaderCellDef>Scanner</th><td mat-cell *matCellDef="let v">{{ v.scanner }}</td></ng-container>
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let v">
            <button mat-icon-button [matMenuTriggerFor]="menu" matTooltip="Update status">
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #menu="matMenu">
              <button mat-menu-item (click)="updateStatus(v, 'Acknowledged')">Acknowledge</button>
              <button mat-menu-item (click)="updateStatus(v, 'Ignored')">Ignore (Accept Risk)</button>
              <button mat-menu-item (click)="updateStatus(v, 'Patched')">Mark as Patched</button>
            </mat-menu>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>
    </mat-card-content>
  </mat-card>
</div>