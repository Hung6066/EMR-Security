<!-- security-settings.component.html -->
<div class="security-container">
  <h1>Cài đặt Bảo mật</h1>

  <!-- Password Section -->
  <mat-card>
    <mat-card-header>
      <mat-card-title>
        <mat-icon>lock</mat-icon>
        Mật khẩu
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <p>Thay đổi mật khẩu định kỳ để bảo vệ tài khoản của bạn</p>
    </mat-card-content>
    <mat-card-actions>
      <button mat-raised-button color="primary" (click)="changePassword()">
        Đổi mật khẩu
      </button>
    </mat-card-actions>
  </mat-card>

  <!-- Two-Factor Authentication -->
  <mat-card>
    <mat-card-header>
      <mat-card-title>
        <mat-icon>verified_user</mat-icon>
        Xác thực 2 bước
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="two-factor-status">
        <div class="status-badge" [class.enabled]="twoFactorEnabled">
          <mat-icon>{{ twoFactorEnabled ? 'check_circle' : 'cancel' }}</mat-icon>
          <span>{{ twoFactorEnabled ? 'Đã bật' : 'Chưa bật' }}</span>
        </div>
        <p>
          {{ twoFactorEnabled 
            ? 'Tài khoản của bạn được bảo vệ bằng xác thực 2 bước'
            : 'Tăng cường bảo mật bằng cách bật xác thực 2 bước' }}
        </p>
      </div>
    </mat-card-content>
    <mat-card-actions>
      <button mat-raised-button 
              [color]="twoFactorEnabled ? 'warn' : 'primary'"
              (click)="twoFactorEnabled ? disable2FA() : enable2FA()">
        {{ twoFactorEnabled ? 'Tắt' : 'Bật' }} xác thực 2 bước
      </button>
      <button mat-raised-button 
              *ngIf="twoFactorEnabled"
              (click)="regenerateBackupCodes()">
        Tạo lại mã dự phòng
      </button>
    </mat-card-actions>
  </mat-card>

  <!-- Active Sessions -->
  <mat-card>
    <mat-card-header>
      <mat-card-title>
        <mat-icon>devices</mat-icon>
        Phiên đăng nhập
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <p>Quản lý các thiết bị đang đăng nhập vào tài khoản của bạn</p>
      
      <table mat-table [dataSource]="sessions" class="mat-elevation-z2">
        <ng-container matColumnDef="deviceInfo">
          <th mat-header-cell *matHeaderCellDef>Thiết bị</th>
          <td mat-cell *matCellDef="let session">
            <div class="device-info">
              <mat-icon>{{ getDeviceIcon(session.deviceInfo) }}</mat-icon>
              <span>{{ session.deviceInfo }}</span>
            </div>
          </td>
        </ng-container>

        <ng-container matColumnDef="ipAddress">
          <th mat-header-cell *matHeaderCellDef>IP Address</th>
          <td mat-cell *matCellDef="let session">
            {{ session.ipAddress }}
            <div class="location">{{ session.location }}</div>
          </td>
        </ng-container>

        <ng-container matColumnDef="lastActivityAt">
          <th mat-header-cell *matHeaderCellDef>Hoạt động lần cuối</th>
          <td mat-cell *matCellDef="let session">
            {{ session.lastActivityAt | date:'dd/MM/yyyy HH:mm' }}
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Thao tác</th>
          <td mat-cell *matCellDef="let session">
            <button mat-icon-button 
                    color="warn" 
                    (click)="revokeSession(session.id)"
                    matTooltip="Thu hồi phiên">
              <mat-icon>block</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumnsSession"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumnsSession;"></tr>
      </table>
    </mat-card-content>
    <mat-card-actions>
      <button mat-raised-button color="warn" (click)="revokeAllSessions()">
        Thu hồi tất cả phiên khác
      </button>
    </mat-card-actions>
  </mat-card>

  <!-- Login History -->
  <mat-card>
    <mat-card-header>
      <mat-card-title>
        <mat-icon>history</mat-icon>
        Lịch sử đăng nhập
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <table mat-table [dataSource]="loginHistory" class="mat-elevation-z2">
        <ng-container matColumnDef="attemptedAt">
          <th mat-header-cell *matHeaderCellDef>Thời gian</th>
          <td mat-cell *matCellDef="let attempt">
            {{ attempt.attemptedAt | date:'dd/MM/yyyy HH:mm:ss' }}
          </td>
        </ng-container>

        <ng-container matColumnDef="ipAddress">
          <th mat-header-cell *matHeaderCellDef>IP Address</th>
          <td mat-cell *matCellDef="let attempt">
            {{ attempt.ipAddress }}
          </td>
        </ng-container>

        <ng-container matColumnDef="location">
          <th mat-header-cell *matHeaderCellDef>Vị trí</th>
          <td mat-cell *matCellDef="let attempt">
            {{ attempt.location }}
          </td>
        </ng-container>

        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Trạng thái</th>
          <td mat-cell *matCellDef="let attempt">
            <mat-icon [color]="getStatusColor(attempt.isSuccessful)">
              {{ getStatusIcon(attempt.isSuccessful) }}
            </mat-icon>
            <span class="status-text" [class.failed]="!attempt.isSuccessful">
              {{ attempt.isSuccessful ? 'Thành công' : 'Thất bại' }}
            </span>
            <div *ngIf="!attempt.isSuccessful" class="failure-reason">
              {{ attempt.failureReason }}
            </div>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumnsHistory"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumnsHistory;"></tr>
      </table>
    </mat-card-content>
  </mat-card>
</div>